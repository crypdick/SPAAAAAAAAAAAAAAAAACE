<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <link href="exoplanets.css" type="text/css" rel="stylesheet">
    <title>Orbit Layout Modes</title>
    <meta charset="utf-8" />
  </head>
  
  <script src="../src/rainbowvis.js"></script>
  
  <script>

    // this function sends the data to the draw orbit function
    // ran onload of page
    function makeViz() {
      d3.json("../exoplanet_data/planets.json", function(data) {drawOrbit(data)});
    }

    function rainbowify(min, max) {
      var numberOfItems = Math.round(max-min)+1;
      var rainbow = new Rainbow(); 
      rainbow.setNumberRange(0, numberOfItems);
      return rainbow;
    }
 
   // var test = rainbowify(1,10);
   // alert(test.colourAt(10)); 



    // this creates random arrays for the planet speeds and the NA ring
    // 3718 is the number of planets in the JSON file
    var randoms = Array(3719); // for planet speeds
    var spanrandoms = Array(3719); // for NaN lightyears to create a span of the ring
    var shouldbepaused = false;
    // populate the arrays
    for(var i = 0; i < randoms.length; i++){
      randoms[i] = Math.random()*0.2 + 0.15; // speeds are between 0.15 and .35
      spanrandoms[i] = Math.random()*0.25 + 0.25; // span distance from earth btwn 0.25  and .5
    }

    // most work is done in this function, which recieves the data onload
    function drawOrbit(_data) {

      orbit = d3.layout.orbit() // instantiates a new orbit class
      .size([700,700]) // sets the size of the visualization
      .children(function(d) {return d.values}) // sets the function to be used to find children (planets are children to suns, moons are children to planets)
      
      // set orbital speed to random since speed means nothing and we are going for looks
      // for solar systems use more like --> .revolution(function(d) {return d.orbital_period == "NA" ? 1 : d.orbital_period/1000})
      .revolution(function(d) {return randoms[d.FIELD1]})

      // distance of the orbit
      // if the value is NA, replace with distance in random array
      // this was done so that there was a spread in these planets, otherwise it looks like a solid ring
      .totallyrad(function(d) { return isNaN(d.light_years) ? 400+spanrandoms[d.FIELD1]*200 : 1 * Math.log(d.light_years)*40-40})
      
      // restructures the data
      // creates a depth field for each planet (used later to color earth diff from exoplanets)
      // creates a random starting point for the planet
      .nodes(_data);

    

      // add the data to the visualization and set cursor behavior
      // creates a node for each planet
      d3.select("svg") // to the svg part of the page
      .append("g") // add a group g
      .attr("class", "viz") // of the "viz" class
      .attr("transform", "translate(150,150)") // pushes viz over and down by 150
      .selectAll("g.node") // select all the nodes made in the next couple lines
        .data(orbit.nodes()).enter() // add the data
        .append("g").attr("class", "node")  // add a node for each data point
      // set behavior for cursor going over a node (runs nodeOver function)
      .on("mouseover", nodeOver)
      // set behavior for cursor leaving a node (runs nodeOut function)
      .on("mouseout", nodeOut)
      
      planetColors = {1: "white", 2: "GreenYellow", 3: "orange", 4: "OrangeRed", 5: "red", 6: "darkred", 7: "MediumSpringGreen", 8: "Orchid"}

      // add a circle at the data points
      d3.selectAll("g.node") // sellect all the nodes
      .append("circle") // add a circle
      // set the radius of the circle
      // if radius is NA, return 1, if there is a radius return radius*5, and if there is no radius value return 5
      .attr("r", function(d) {return d.radius ? d.radius == "NA" ? 0.5+1 : d.radius*0.5+1 : 48 })
      // fill the circle blue if it's the earth ("root" of the data), white otherwise
      .style("fill", function(d) {return d.depth == 0 ? "blue" : "white"})
      .style("stroke", function(d) {return d.depth == 0 ? "black" : "lightgray"})
      .style("stroke-width", function(d) {return d.depth == 0 ? 90 : 1});

      d3.select("#buttons").append("button").html("Pause Animation").on("click", pause)
      d3.select("#buttons").append("button").html("Start Animation").on("click", start)
      d3.select("#buttons").append("button").html("Planet Number").on("click", function() {colorbyfeature("plnum")})
      d3.select("#buttons").append("button").html("Orbital Period").on("click", function() {colorbyfeature("orbper")})
      d3.select("#buttons").append("button").html("Planet Temperature").on("click", function() {colorbyfeature("pltemp")})
      d3.select("#buttons").append("button").html("Radius").on("click", function() {colorbyfeature("rad")})
      d3.select("#buttons").append("button").html("Distance from Earth").on("click", function() {colorbyfeature("dist")})
      d3.select("#buttons").append("button").html("Discovery Year").on("click", function() {colorbyfeature("discyear")})
      d3.select("#buttons").append("button").html("Discovery Method").on("click", function() {colorbyfeature("discmeth")})

      // when the animation dispatches a tick, this function redraws each element at the new x,y
      orbit.on("tick", function() {
        d3.selectAll("g.node") // sell all the nodes of the group
        .attr("transform", function(d) {
          return "translate(" + d.x +"," + d.y +")"}); // move to the new location
      });
      
      // color function
      function colorbyfeature(feature){
        if (feature == "plnum"){
          d3.selectAll("circle").style("fill", function(d) {return d.depth == 0 ? "blue" : d.depth == 1 ? planetColors[d.pl_pnum] : "lightgray"});
        }
        if (feature == "orbper"){
          var colors = rainbowify(Math.log(orbit.minOrbitalPeriod()), Math.log(orbit.maxOrbitalPeriod()));
          d3.selectAll("circle").style("fill", function(d) {return d.depth == 0 ? "blue" : d.depth == 1 ? isNaN(d.orbital_period) ? "lightgray": colors.colourAt(Math.round(d.orbital_period - orbit.minOrbitalPeriod())) : "lightgray"});
        }
        if (feature == "pltemp"){
          var colors = rainbowify(orbit.minPlanetTemp(), orbit.maxPlanetTemp());
          d3.selectAll("circle").style("fill", function(d) {return d.depth == 0 ? "blue" : d.depth == 1 ? isNaN(d.planet_temp) ? "lightgray": colors.colourAt(Math.round(d.planet_temp - orbit.minPlanetTemp())) : "lightgray"});
        }
        if (feature == "rad"){
        }
        if (feature == "dist"){

        }
        if (feature == "discyear"){

        }
        if (feature == "discmeth"){

        }
      }
      // start the animation
      orbit.start();

      // pause function
      function pause(){
        orbit.stop();
        shouldbepaused = true;
      }

      //start function
      function start(){
        orbit.start();
        shouldbepaused = false;
      }
      // sets the behavior for when the cursor goes over a node (planet)
      function nodeOver(d) {
        // stop the animation
        orbit.stop();
        // draw a black ring around each planet
        d3.select(this)
        .select("circle")
        .style("stroke", "black")
        .style("stroke-width", 3);
      }

      // sets the behavior for when the cursor leaves a node (planet)
      function nodeOut() {
        // restart the animation
        shouldbepaused ? orbit.stop() : orbit.start();
        // remove the border from the circle
        d3.selectAll("g.node > circle")
        .style("stroke", function(d) {return d.depth == 0 ? "black" : "lightgray"})
        .style("stroke-width", function(d) {return d.depth == 0 ? 90 : 1});    
      }
    }
  </script>
  
  <!-- run the makeViz() code on page load -->
  <body onload=makeViz()>
      <!-- add the star background -->
      <div class="stars"></div>
      <!-- add twinkling -->
      <!-- <div class="twinkling"></div> -->
      <div id="viz"> <!-- Place the viz here -->
        <svg></svg> <!-- Place the svg here -->
        <div id="buttons"></div> <!-- Place the buttons here -->
      </div>
    <footer>
      <!-- Place the javascript source code links here -->
      <script src="../src/d3.min.js"></script>
      <script src="d3.layout.orbit.js" charset="utf-8" type="text/javascript"></script>
     


    </footer>
  </body>
</html>